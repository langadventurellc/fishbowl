---
kind: task
id: T-implement-1
parent: F-appearance-settings-type-mapping
status: done
title: Implement mapAppearanceSettingsPersistenceToUI function with unit tests
priority: high
prerequisites:
  - T-create-1
created: "2025-08-01T12:47:16.449892"
updated: "2025-08-01T13:06:55.297734"
schema_version: "1.1"
worktree: null
---

# Implement mapAppearanceSettingsPersistenceToUI function with unit tests

## Purpose

Create the reverse mapping function that converts PersistedAppearanceSettingsData to AppearanceSettingsFormData, enabling UI forms to display persisted appearance settings.

## Implementation Details

### File Location

Create: `packages/ui-shared/src/mapping/settings/mapAppearanceSettingsPersistenceToUI.ts`

### Required Imports

```typescript
import type { AppearanceSettingsFormData } from "../../types/settings/appearanceSettings";
import type { PersistedAppearanceSettingsData } from "@fishbowl-ai/shared";
import { defaultAppearanceSettings } from "../../types/settings/appearanceSettings";
import { applyDefaults } from "../utils/defaults";
import {
  normalizeEnum,
  clampNumber,
  coerceBoolean,
} from "../utils/transformers";
```

### Function Implementation

```typescript
/**
 * Converts PersistedAppearanceSettingsData to AppearanceSettingsFormData
 *
 * @param persistedData - Appearance settings data from persistence layer
 * @returns Converted data ready for UI forms
 *
 * @example
 * const uiData = mapAppearanceSettingsPersistenceToUI({
 *   theme: "dark",
 *   show_timestamps: "always",
 *   show_activity_time: 1,
 *   compact_list: 0,
 *   font_size: 16,
 *   message_spacing: "normal"
 * });
 */
export function mapAppearanceSettingsPersistenceToUI(
  persistedData: PersistedAppearanceSettingsData,
): AppearanceSettingsFormData;
```

## Technical Approach

### Field Mapping Strategy

Convert from persistence format to UI format with proper validation:

1. **Enum Normalization**: Use `normalizeEnum` utility for safe conversions:
   - theme: Ensure valid "light" | "dark" | "system" values
   - showTimestamps: Ensure valid "always" | "hover" | "never" values
   - messageSpacing: Ensure valid "compact" | "normal" | "relaxed" values

2. **Boolean Coercion**: Use `coerceBoolean` for safe boolean conversion:
   - showActivityTime: Convert from various formats to boolean
   - compactList: Convert from various formats to boolean

3. **Numeric Validation**: Use `clampNumber` for fontSize bounds:
   - fontSize: Ensure value stays within 12-20 range

4. **Default Application**: Use `applyDefaults` with `defaultAppearanceSettings`

### Implementation Steps

1. Apply defaults for any missing fields using `applyDefaults`
2. Convert all enum fields using `normalizeEnum` with fallbacks
3. Convert boolean fields using `coerceBoolean` for safe type conversion
4. Clamp fontSize to valid range using `clampNumber`
5. Return properly typed AppearanceSettingsFormData

## Unit Testing Requirements

Create: `packages/ui-shared/src/mapping/settings/__tests__/mapAppearanceSettingsPersistenceToUI.test.ts`

### Test Coverage

1. **Successful mapping** - Verify all fields convert correctly from persistence format
2. **Missing fields handling** - Apply UI defaults when persistence data is incomplete
3. **Invalid enum values** - Handle with appropriate fallbacks to valid UI values
4. **Boolean coercion** - Test various input formats (0/1, true/false, "true"/"false")
5. **FontSize clamping** - Test boundary values and out-of-range inputs
6. **Round-trip conversion** - UI → Persistence → UI maintains data fidelity
7. **Edge cases** - Test with null, undefined, empty objects, corrupted data
8. **Performance** - Verify mapping completes in < 1ms

### Special Test Cases

```typescript
describe("mapAppearanceSettingsPersistenceToUI", () => {
  it("should handle round-trip conversion correctly", () => {
    // Test UI → Persistence → UI data integrity
  });

  it("should coerce boolean values from various formats", () => {
    // Test 0/1, "true"/"false", boolean conversions
  });

  it("should apply defaults for incomplete persistence data", () => {
    // Test partial data with missing fields
  });
});
```

## Acceptance Criteria

- ✓ Function in separate file with single export following project conventions
- ✓ Correctly converts all PersistedAppearanceSettingsData fields to UI format
- ✓ Uses `normalizeEnum` utility for safe enum conversions with UI-appropriate fallbacks
- ✓ Uses `coerceBoolean` for safe boolean field conversion
- ✓ Uses `clampNumber` to enforce fontSize bounds (12-20)
- ✓ Uses `applyDefaults` with `defaultAppearanceSettings` for missing fields
- ✓ Round-trip conversion (UI → Persistence → UI) maintains data fidelity
- ✓ Handles corrupted or invalid persistence data gracefully
- ✓ Maintains full TypeScript type safety
- ✓ Pure function with no side effects
- ✓ Mapping operation completes in < 1ms
- ✓ JSDoc documentation with examples and usage
- ✓ Unit tests achieve 100% code coverage including round-trip testing
- ✓ All tests pass and quality checks are clean

## Integration Requirements

- Import and use common mapping utilities from F-common-mapping-utilities
- Ensure compatibility with both PersistedAppearanceSettingsData and AppearanceSettingsFormData
- Handle potential format differences between persistence and UI layers
- Export function for use by settings loading logic

## Dependencies

- AppearanceSettingsFormData type and defaults (from T-create-1)
- PersistedAppearanceSettingsData from @fishbowl-ai/shared
- Common mapping utilities (normalizeEnum, clampNumber, coerceBoolean, applyDefaults)
- Jest for unit testing

## Security Considerations

- Validate all enum values and provide safe fallbacks
- Ensure fontSize clamping prevents invalid UI values
- Safe boolean coercion prevents type confusion attacks
- No dynamic property access to prevent injection
- Handle malformed persistence data without crashing
- No sensitive data in error messages or logs

### Log

**2025-08-01T18:14:14.195337Z** - Successfully implemented mapAppearanceSettingsPersistenceToUI function with comprehensive unit tests. The function converts PersistedAppearanceSettingsData from the persistence layer to AppearanceSettingsFormData for UI consumption.

Key features implemented:

- Safe enum normalization for theme, showTimestamps, and messageSpacing fields
- Boolean coercion for showActivityTime and compactList fields
- Font size clamping with NaN validation (12-20 range for UI)
- Comprehensive default value handling for null/undefined/missing fields
- Uses common mapping utilities (normalizeEnum, coerceBoolean, clampNumber, applyDefaults)
- Full TypeScript type safety with no 'any' types

All 15 unit tests pass, covering edge cases including invalid inputs, partial data, enum normalization, boolean coercion, number clamping, and round-trip data fidelity. The implementation follows established patterns from general settings mapping and maintains clean separation between UI and persistence concerns.

- filesChanged: ["packages/ui-shared/src/mapping/settings/mapAppearanceSettingsPersistenceToUI.ts", "packages/ui-shared/src/mapping/settings/index.ts", "packages/ui-shared/src/mapping/settings/__tests__/mapAppearanceSettingsPersistenceToUI.test.ts"]
